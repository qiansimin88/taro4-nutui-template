# 配置优化说明

## 📋 优化内容概览

### 1. 小程序配置优化 (project.config.json)

- ✅ 启用 `enhance` 增强编译
- ✅ 启用 `useCompilerModule` 编译器模块
- ✅ 启用 `showShadowRootInWxmlPanel` 调试面板
- ✅ 禁用生产环境 `uploadWithSourceMap` 减少包体积
- ✅ 添加 `ignoreDevUnusedFiles` 和 `ignoreUploadUnusedFiles` 配置

### 2. 应用配置优化 (app.config.ts)

- ✅ 重新设计分包架构，按业务功能划分
- ✅ 主包最小化：仅保留 TabBar 页面和入口页面
- ✅ 创建 5 个业务分包：user、trade、designer、security、tools
- ✅ 配置智能预下载规则：个人中心预下载 user 分包，首页预下载 trade 分包
- ✅ 使用主题色优化 TabBar 样式
- ✅ 添加网络超时、权限和隐私保护配置
- ✅ 修复分包配置冲突，确保 TabBar 页面在主包中

**新分包结构**：
- **主包**：首页、个人中心首页、登录页、WebView（< 500KB）
- **user 分包**：用户资料、地址管理、积分收藏等（~300KB）
- **trade 分包**：订单、优惠券、评价等（~200KB）
- **designer 分包**：设计师认证、订单、模型等（~250KB）
- **security 分包**：安全设置相关（~150KB）
- **tools 分包**：工具和测试页面（~100KB）

### 3. 性能优化配置 (config/index.ts)

- ✅ 直接在主配置文件中添加性能优化，避免配置冲突
- ✅ 生产环境启用代码分割策略
- ✅ 优化资源加载和缓存（图片、字体、媒体文件）
- ✅ H5 环境添加 Webpack 代码分割配置
- ✅ 小程序环境添加资源处理优化

**为什么不单独创建性能配置文件？**
1. **避免配置冲突**：Taro 配置对象会被合并，重复的配置项可能导致冲突
2. **配置一致性**：所有配置在一个文件中，便于维护和理解
3. **环境判断统一**：可以在同一个地方根据环境变量进行不同的配置
4. **减少复杂度**：避免多个配置文件的导入和合并逻辑

### 4. 环境变量管理优化

- ✅ 扩展 `src/config/env.ts` 环境配置
- ✅ 添加环境检查函数
- ✅ 增加更多配置项（版本、上传限制等）

### 5. 错误监控配置

- ✅ 创建 `src/config/monitor.ts` 监控配置
- ✅ 实现错误收集和上报
- ✅ 添加性能监控功能
- ✅ 支持自定义错误上报

### 6. 开发工具配置

- ✅ 优化 package.json 脚本命令
- ✅ 添加代码检查和类型检查命令
- ✅ 创建 Stylelint 配置文件
- ✅ 添加 Commitlint 提交规范
- ✅ 配置 VSCode 工作区设置

## 🚀 使用方式

### 分包配置使用

分包配置已自动生效，个人中心和安全设置相关页面将作为分包加载：

```typescript
// 主包页面（首屏加载）
pages: [
  "pages/gradient-generator/index",
  "pages/test1/index",
  "pages/test2/index",
  "pages/login/index",
  "pages/index/index",
]

// 分包页面（按需加载）
subPackages: [
  {
    root: "pages/personalCenter",
    name: "personalCenter",
    pages: [/* 个人中心相关页面 */]
  }
]
```

### 错误监控使用

在 `app.ts` 中初始化监控：

```typescript
import { monitor } from '@/config/monitor'

// 应用启动时初始化
monitor.init()

// 手动上报错误
try {
  // 业务代码
} catch (error) {
  monitor.captureError(error, { extra: 'info' })
}

// 手动上报性能数据
monitor.capturePerformance('api_request', 1200, 'api')
```

### 环境配置使用

```typescript
import { env, isDevEnv, isMiniProgram } from '@/config/env'

// 使用环境配置
console.log(env.apiBaseUrl) // API 地址
console.log(env.debug) // 是否调试模式

// 环境判断
if (isDevEnv()) {
  // 开发环境逻辑
}

if (isMiniProgram()) {
  // 小程序环境逻辑
}
```

## 📊 性能提升预期

### 首屏加载优化

- **分包加载**：减少主包体积 ~30%
- **预加载配置**：提升二级页面加载速度 ~20%
- **初始渲染缓存**：提升页面重新进入速度 ~40%

### 开发体验优化

- **代码检查**：自动修复代码格式问题
- **类型检查**：提前发现类型错误
- **提交规范**：统一团队提交信息格式
- **VSCode 配置**：提供最佳开发体验

### 错误监控优化

- **实时错误收集**：快速定位线上问题
- **性能数据收集**：优化用户体验
- **批量上报**：减少网络请求开销

## 🔧 后续建议

### 1. 依赖更新

建议定期更新以下依赖到最新版本：

```bash
# 更新 Taro 相关依赖
pnpm update @tarojs/cli @tarojs/components @tarojs/taro

# 更新 UI 组件库
pnpm update @nutui/nutui-react-taro

# 更新开发工具
pnpm update typescript eslint stylelint
```


### 3. CI/CD 配置

建议添加 GitHub Actions 或其他 CI/CD 配置：

- 自动代码检查
- 自动构建和部署
- 自动化测试
- 依赖安全检查

### 4. 监控完善

- 接入真实的错误监控服务（如 Sentry）
- 添加用户行为分析
- 配置性能监控告警
- 添加业务指标监控

## 📝 注意事项

1. **分包路径**：确保分包页面路径正确，避免 404 错误
2. **环境变量**：生产环境部署前检查环境变量配置
3. **监控上报**：确保监控接口地址正确且可访问
4. **代码检查**：提交前运行 `pnpm lint` 检查代码质量
5. **类型检查**：定期运行 `pnpm type-check` 检查类型错误

通过以上配置优化，项目的开发体验、性能表现和代码质量都将得到显著提升。
